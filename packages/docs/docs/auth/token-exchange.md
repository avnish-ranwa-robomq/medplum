import CodeBlock from '@theme/CodeBlock'

# Token Exchange

## Overview

Medplum's `/auth/exchange` endpoint provides a convenient way to exchange an external access token for a Medplum access token without redirecting the user. This is useful when your application has already authenticated the user with an external identity provider, such as [Auth0](https://auth0.com/), and would access the medplum api services without requiring the user to log in again.

## Set up your ClientApplication

In order to authenticate the user, Medplum's authentication server will call the `/userinfo` endpoint of the external identity provider and check for a valid response. Therefore, it is important that the corresponding [`ClientApplication`](https://app.medplum.com/ClientApplication) in your Medplum project has an identity provider set up with a user info URL specified.

To set up an identity provider for your [`ClientApplication`](https://app.medplum.com/ClientApplication):

1. Log in to your Medplum project.
1. Navigate to the [ClientApplications page](https://app.medplum.com/ClientApplication).
1. Click on the [`ClientApplication`](https://app.medplum.com/ClientApplication) that you would like to set up with an identity provider.
1. Click the "Edit" tab.
1. Scroll down to the "Identity Provider" section.
1. Enter the `/userinfo` URL for your external identity provider in the "User Info URL" textbox.
1. Click "Save" to save your changes.

## Calling `/auth/exchange`

Once you have set up the identity provider for your [`ClientApplication`](https://app.medplum.com/ClientApplication), you can use the `/auth/exchange` endpoint to exchange the external access token for a Medplum access token.

To use the `/auth/exchange` endpoint, you will need to POST the following information:

- **projectId**: The ID of your Medplum project.
- **clientId**: The ID of the [`ClientApplication`](https://app.medplum.com/ClientApplication) in your Medplum project that will be making the exchange request.
- **externalAccessToken**: The access token that was generated by the external identity provider when the user logged in.

:::tip Example

```bash
curl -X POST 'https://api.medplum.com/auth/exchange' \
--header 'Content-Type: application/json' \
--data-raw \'{
"projectId": "<your project ID>",
"clientId": "<your ClientApplication ID>",
"externalAccessToken": "<external access token>"
```

:::

The response will include a Medplum access token, which you can use to access Medplum's services on behalf of the authenticated user. You can use this response with `...()` SDK function to set your active Medplum login.

In summary, the `/auth/exchange` endpoint provides a simple way to exchange an external access token for a Medplum access token without requiring the user to log in again. To use this endpoint, you will need to provide the projectId, clientId, and externalAccessToken parameters, and ensure that the corresponding ClientApplication in your Medplum project has an identity provider set up with a user info URL specified.
